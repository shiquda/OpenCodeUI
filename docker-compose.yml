# ============================================
# OpenCode WebUI - Docker Compose
# ============================================
#
# 架构:
#   frontend (Caddy)  :3000 -> 静态文件
#   backend  (Ubuntu) :4096 -> opencode serve
#
# 两个独立容器，各自暴露端口给宿主机 nginx 反代
#
# 使用方法:
#   cp .env.example .env    # 填写 API Key
#   docker compose up -d    # 启动

services:
  # ---- 前端：静态文件 ----
  frontend:
    build:
      context: .
      dockerfile: docker/Dockerfile.frontend
    container_name: opencode-frontend
    restart: unless-stopped
    ports:
      - "127.0.0.1:${FRONTEND_PORT:-3000}:3000"

  # ---- 后端：opencode serve ----
  backend:
    build:
      context: .
      dockerfile: docker/Dockerfile.backend
    container_name: opencode-backend
    restart: unless-stopped
    ports:
      - "127.0.0.1:${API_PORT:-4096}:4096"
    deploy:
      resources:
        limits:
          memory: 4G
    volumes:
      - ${WORKSPACE:-./workspace}:/workspace
      - opencode-data:/root/.local/share/opencode
      - opencode-config:/root/.config/opencode
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY:-}
      - GROQ_API_KEY=${GROQ_API_KEY:-}
      - MISTRAL_API_KEY=${MISTRAL_API_KEY:-}
      - XAI_API_KEY=${XAI_API_KEY:-}
      - OPENCODE_SERVER_PASSWORD=${OPENCODE_SERVER_PASSWORD:-}
      - OPENCODE_SERVER_USERNAME=${OPENCODE_SERVER_USERNAME:-opencode}
      - WORKSPACE=/workspace

volumes:
  opencode-data:
  opencode-config:
